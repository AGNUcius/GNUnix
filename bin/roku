#!/usr/bin/python

# remix https://github.com/paulmouzas/roku-remote.git

# enable developer mode on your roku
# HOME HOME HOME  UP UP  RIGHT LEFT  RIGHT LEFT  RIGHT

# sudo easy_install pip
# sudo pip install requests

import requests, curses, socket, sys

KEY_MAP = {}
KEY_MAP.update({
    27:               'BACK',   #Escape
    10:               'SELECT', #Enter
    curses.KEY_F1:    'INFO',
    curses.KEY_HOME:  'HOME',
    curses.KEY_UP:    'UP',
    curses.KEY_DOWN:  'DOWN',
    curses.KEY_LEFT:  'LEFT',
    curses.KEY_RIGHT: 'RIGHT',
    127:              'BACKSPACE'
})

DISCOVER_GROUP = ('239.255.255.250', 1900)
DISCOVER_MESSAGE = '''\
M-SEARCH * HTTP/1.1\r\n\
Host: %s:%s\r\n\
Man: "ssdp:discover"\r\n\
ST: roku:ecp\r\n\r\n\
''' % DISCOVER_GROUP

def find_roku():
    s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    s.sendto(DISCOVER_MESSAGE, DISCOVER_GROUP)
    data = s.recv(1024)
    s.close()
    return data

class HTTPResponse(object):
    def __init__(self, response_text):
        response = response_text.split('\r\n')
        status_line = response[0].split()
        self.http_version = status_line[0]
        self.status_code = status_line[1]
        self.status = status_line[2]
        self.headers = {}
        for line in response[1:]:
            line = line.split()
            if len(line) == 2:
                header_name = line[0][:-1]
                header_value = line[1]
                self.headers[header_name.lower()] = header_value.lower()

def main():
    if len(sys.argv) < 2:
        print 'Searching...'
        print 'Ctrl-c to exit'

        response_text = find_roku()
        response = HTTPResponse(response_text)
        url = response.headers['location']
    else:
        url = 'http://' + sys.argv[1] + ':8060/'

    try:
        scr = curses.initscr(); curses.noecho(); scr.keypad(1)
        scr.addstr(0, 16, 'Posting to %s' % url)
        scr.addstr(1, 0, 'ESC:  Back')
        scr.addstr(2, 0, 'RET:  Select')
        scr.addstr(3, 0, 'HOME: Home')
        scr.addstr(4, 0, 'SPC:  Play/Pause')
        scr.addstr(5, 0, 'F1 :  Info')
        scr.addstr(6, 0, '')

        while True:
            key = scr.getch()
            cmd = KEY_MAP.get(key, '')
            if cmd == '': cmd = 'Lit_%' + "%x" % key
            requests.post(url + 'keypress/' + cmd)

    finally:
        curses.endwin()

if __name__ == '__main__':
    main()
